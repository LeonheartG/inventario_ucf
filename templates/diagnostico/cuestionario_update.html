{% extends 'base/base.html' %}

{% block title %}Editar Cuestionario - UCF{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-white">Editar Cuestionario y Preguntas</h6>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="titulo" class="form-label">Título</label>
                        <input type="text" class="form-control" id="titulo" name="titulo" value="{{ form.titulo.value|default:'' }}" required>
                    </div>
                    <div class="col-md-4">
                        <label for="activo" class="form-label">Estado</label>
                        <select class="form-select" id="activo" name="activo">
                            <option value="True" {% if form.activo.value %}selected{% endif %}>Activo</option>
                            <option value="False" {% if not form.activo.value %}selected{% endif %}>Inactivo</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="descripcion" class="form-label">Descripción</label>
                    <textarea class="form-control" id="descripcion" name="descripcion" rows="3" required>{{ form.descripcion.value|default:'' }}</textarea>
                </div>
                
                <h5 class="text-primary mb-3">Preguntas</h5>
                
                {{ formset.management_form }}
                
                <div id="formset-container">
                    {% for form in formset %}
                        <div class="card mb-3 formset-form">
                            <div class="card-body">
                                <div class="row align-items-center mb-2">
                                    <div class="col-auto">
                                        <strong>Pregunta {{ forloop.counter }}</strong>
                                    </div>
                                    <div class="col text-end">
                                        {{ form.DELETE.label_tag }}
                                        {{ form.DELETE }}
                                        {{ form.id }}
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label for="{{ form.texto.id_for_label }}" class="form-label">Texto de la pregunta</label>
                                        {{ form.texto }}
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="{{ form.tipo.id_for_label }}" class="form-label">Tipo</label>
                                        {{ form.tipo }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.categoria.id_for_label }}" class="form-label">Categoría</label>
                                        {{ form.categoria }}
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.orden.id_for_label }}" class="form-label">Orden</label>
                                        {{ form.orden }}
                                    </div>
                                </div>
                                
                                {{ form.cuestionario }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                
                <div class="mb-3">
                    <button type="button" id="add-form" class="btn btn-outline-primary">
                        <i class="fas fa-plus"></i> Agregar Pregunta
                    </button>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'cuestionario_list' %}" class="btn btn-secondary me-md-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.querySelector('#formset-container');
        const addButton = document.querySelector('#add-form');
        const totalForms = document.querySelector('#id_form-TOTAL_FORMS');
        
        let formCount = parseInt(totalForms.value);
        
        addButton.addEventListener('click', function() {
            const formRegex = RegExp(`form-(\\d+)-`,'g');
            const lastForm = document.querySelector('.formset-form:last-child');
            
            if (lastForm) {
                const newForm = lastForm.cloneNode(true);
                formCount++;
                
                // Actualizar IDs
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, function(match, index) {
                    return `form-${formCount - 1}-`;
                });
                
                // Limpiar valores
                newForm.querySelectorAll('input[type=text], textarea').forEach(input => {
                    input.value = '';
                });
                
                // Desmarcar checkbox DELETE
                newForm.querySelector('input[type=checkbox]').checked = false;
                
                container.appendChild(newForm);
                totalForms.value = formCount;
                
                // Actualizar el contador visible
                newForm.querySelector('strong').innerText = `Pregunta ${formCount}`;
            }
        });
    });
</script>
{% endblock %}